# UG-P0-103 Progress Update

## Implemented
- Added feature flag `COMMAND_SAFETY_ENFORCE_REASON` to `dashboard-api` settings with default `false`.
- Added strong command safety enforcement (flag-gated) in `POST /commands`.
- Strong commands are currently defined as:
  - `HALT`
  - `FLATTEN`
  - `CLOSE_ALL`
  - `KILL_SWITCH`
- When enforcement is enabled and command type is strong:
  - `reason` must be a non-empty string.
  - `expires_at` must be a valid ISO-8601 datetime with timezone and in the future.
  - invalid payload returns `400` with `code=COMMAND_SAFETY_VALIDATION_FAILED` and `details.error_codes`.
- Added nullable persistence fields on `commands`:
  - `reason` (`TEXT`, nullable)
  - `expires_at` (`TIMESTAMPTZ`, nullable)
- Exposed flag state via `GET /capabilities` as `command_safety_enforce_reason`.

## How to enable
Set environment variable for dashboard-api:

```bash
export COMMAND_SAFETY_ENFORCE_REASON=true
```

## Tests added
- Flag OFF: strong command without reason/expires is accepted.
- Flag ON: strong command without reason/expires is rejected.
- Flag ON: strong command with reason + future expires is accepted.
- Capabilities endpoint includes the enforcement flag state.

## Run tests
From repo root:

```bash
cd services/dashboard-api
pytest
```
