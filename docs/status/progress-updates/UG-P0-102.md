# UG-P0-102 â€” execution SAFE_MODE gating + capabilities

## What was gated
- Added a single SAFE_MODE gate at the order placement entrypoint: `POST /execution/order-intents`.
- New order placement is now blocked when execution mode resolves to `SAFE_MODE` or `HALTED`.
- Block responses use the existing error envelope with machine code:
  - `SAFE_MODE_BLOCKED`
- The gate executes before symbol/exchange checks and before any live upstream call path.

## SAFE_MODE toggle
Set `EXECUTION_SAFE_MODE` in execution service environment:
- `SAFE_MODE` (default): blocks all new order placement.
- `NORMAL`: allows normal order placement behavior.
- `DEGRADED`: reports degraded state via capabilities, but does not hard-block new orders.
- `HALTED`: blocks all new order placement.

Optional:
- `EXECUTION_DEGRADED_REASON` sets an operator-provided reason surfaced in `/capabilities` when mode is `DEGRADED`, `SAFE_MODE`, or `HALTED`.

## Capabilities additions
`GET /capabilities` now includes:
- `safe_mode`: `NORMAL | DEGRADED | SAFE_MODE | HALTED`
- `allowed_actions`: action list based on mode (`["CANCEL"]` in non-normal modes, `["NEW_ORDER", "CANCEL"]` in normal mode)
- `degraded_reason`: string or null

## Tests
From repository root:

```bash
pytest services/execution/tests/test_api.py
pytest services/execution/tests
```
