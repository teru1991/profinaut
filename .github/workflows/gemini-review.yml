name: Gemini PR Review (with GitHub Suggestions)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: gemini-review-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  review:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/gemini review')

    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR number & basic guards
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const authorAssociation = context.payload.comment.author_association || 'NONE';
            const allowedAssociations = ['OWNER', 'MEMBER', 'COLLABORATOR'];
            const isTrustedRequester = allowedAssociations.includes(authorAssociation);

            // Safe-by-default: do not use repository secrets on fork PRs.
            const isFork = pr.head.repo.full_name !== pr.base.repo.full_name;

            core.setOutput('number', String(prNumber));
            core.setOutput('isFork', String(isFork));
            core.setOutput('isTrustedRequester', String(isTrustedRequester));
            core.setOutput('authorAssociation', authorAssociation);
            core.setOutput('headSha', pr.head.sha);
            core.setOutput('baseSha', pr.base.sha);
            core.setOutput('title', pr.title || '');
            core.setOutput('author', pr.user?.login || '');

      - name: Skip untrusted requesters
        if: steps.pr.outputs.isTrustedRequester != 'true'
        run: |
          echo "Comment author association '${{ steps.pr.outputs.authorAssociation }}' is not allowed to trigger Gemini review."

      - name: Skip forks (safe default)
        if: steps.pr.outputs.isTrustedRequester == 'true' && steps.pr.outputs.isFork == 'true'
        run: |
          echo "Fork PR detected; skipping Gemini review to avoid secrets exposure."

      - name: Guard required secret
        if: steps.pr.outputs.isTrustedRequester == 'true' && steps.pr.outputs.isFork != 'true'
        id: secret_guard
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "${GEMINI_API_KEY}" ]; then
            echo "present=false" >> "$GITHUB_OUTPUT"
          else
            echo "present=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment missing secret
        if: steps.pr.outputs.isTrustedRequester == 'true' && steps.pr.outputs.isFork != 'true' && steps.secret_guard.outputs.present != 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: 'âš ï¸ Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`GEMINI_API_KEY` ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæœªè¨­å®šã§ã™ã€‚Repository Settings > Secrets and variables > Actions ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚',
            });

      - name: Fetch PR diff (no checkout)
        if: steps.pr.outputs.isTrustedRequester == 'true' && steps.pr.outputs.isFork != 'true' && steps.secret_guard.outputs.present == 'true'
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = Number('${{ steps.pr.outputs.number }}');

            const res = await github.request('GET /repos/{owner}/{repo}/pulls/{pull_number}', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              headers: { accept: 'application/vnd.github.v3.diff' },
            });

            let diffText = res.data;

            // Avoid token explosion on huge changesets.
            const MAX_CHARS = 120000;
            if (diffText.length > MAX_CHARS) {
              diffText = `${diffText.slice(0, MAX_CHARS)}\n\n[TRUNCATED]\n`;
            }

            fs.writeFileSync('diff.txt', diffText);

      - name: Build Gemini prompt
        if: steps.pr.outputs.isTrustedRequester == 'true' && steps.pr.outputs.isFork != 'true' && steps.secret_guard.outputs.present == 'true'
        id: prompt
        run: |
          cat > prompt.txt <<'PROMPT'
          ã‚ãªãŸã¯ GitHub ä¸Šã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
          ä»¥ä¸‹ã® Diff ã‚’åˆ†æã—ã€Profinaut ã®é‹ç”¨åŸå‰‡ï¼ˆSafe-by-default / 1PR=1scope / contracts additive-only / å±é™ºé ˜åŸŸãƒ­ãƒƒã‚¯ï¼‰ã«å³å¯†ã«å¾“ã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ã€æœ€å„ªå…ˆã®è¦³ç‚¹ï¼ˆå¿…é ˆã§ç¢ºèªï¼‰ã€‘
          1) Safe-by-default:
             - ä¸æ˜/æ•´åˆä¸èƒ½/ä¾å­˜ä¸é”æ™‚ã« â€œæ–°è¦ç™ºæ³¨ç¦æ­¢â€ ã‚’æ—¢å®šã«ã§ãã¦ã„ã‚‹ã‹
             - SAFE_MODE / Kill Switch / Close-only / Flatten ã®é€¸è„±ã‚„æŠœã‘ãŒãªã„ã‹
          2) 1PR=1scope:
             - å¤‰æ›´ãŒè¤‡æ•°ã‚¹ã‚³ãƒ¼ãƒ—ã«è·¨ã£ã¦ã„ãªã„ã‹ï¼ˆè·¨ã‚‹ãªã‚‰åˆ†å‰²ã‚’ææ¡ˆï¼‰
          3) contracts:
             - contracts/** ã¯ additive-onlyï¼ˆè¿½è¨˜ã®ã¿ï¼‰ã‹ã€‚ç ´å£Šå¤‰æ›´ãŒç–‘ã‚ã‚Œã‚‹å ´åˆã¯ãƒ–ãƒ­ãƒƒã‚¯ã€‚
          4) å±é™ºé ˜åŸŸï¼ˆCI/infra/lockfile/migrations ç­‰ï¼‰:
             - å¤‰æ›´ãŒå…¥ã£ã¦ã„ãªã„ã‹ã€å…¥ã£ã¦ã„ã‚‹ãªã‚‰ç†ç”±ã¨ãƒªã‚¹ã‚¯ã‚’æ˜ç¢ºåŒ–

          ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡ºåŠ›ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¦ï¼‰ã€‘
          - æŒ‡æ‘˜ã¯æ—¥æœ¬èªã§æ›¸ãã“ã¨ã€‚
          - ä¿®æ­£ææ¡ˆãŒ â€œå…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´â€ ã«ãªã‚‹å ´åˆã¯ã€å¿…ãš GitHub Suggestion è¨˜æ³•ã‚’ä½¿ã†ã“ã¨ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯é©ç”¨ã§ãã‚‹å½¢ï¼‰ã€‚
            ä¾‹:
            ```suggestion
            ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ã®ã¿
            ```
          - suggestion ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€Œå·®åˆ†å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»è©²å½“ç®‡æ‰€ã«å¯¾å¿œã™ã‚‹æœ€å°å˜ä½ã€ã§å‡ºã™ã“ã¨ï¼ˆå·¨å¤§ãªç½®æ›ã¯ç¦æ­¢ï¼‰ã€‚
          - ä¿®æ­£æ¡ˆãŒãªã„å ´åˆã¯ã€ç„¡ç†ã« suggestion ã‚’ä½œã‚‰ãªã„ã“ã¨ã€‚
          - è‰¯ã„ç‚¹ãŒã‚ã‚Œã°çŸ­ãè¤’ã‚ã‚‹ã“ã¨ï¼ˆãŸã ã—éå‰°ã«ç§°è³›ã—ãªã„ï¼‰ã€‚
          - æœ€å¾Œã« â€œã“ã®PRã‚’ãã®ã¾ã¾ãƒãƒ¼ã‚¸ã—ã¦è‰¯ã„ã‹â€ ã‚’ã€ŒOK / æ¡ä»¶ä»˜ãOK / NGã€ã§çµè«–ã—ã€ç†ç”±ã‚’ç®‡æ¡æ›¸ãã§ç¤ºã™ã“ã¨ã€‚

          ã€Diffã€‘
          PROMPT

          cat diff.txt >> prompt.txt

      - name: Call Gemini API
        if: steps.pr.outputs.isTrustedRequester == 'true' && steps.pr.outputs.isFork != 'true' && steps.secret_guard.outputs.present == 'true'
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL }}
        run: |
          set -euo pipefail
          MODEL="${GEMINI_MODEL:-gemini-1.5-flash}"

          # Build JSON payload using jq to safely handle prompt content
          jq -n --rawfile prompt prompt.txt \
            '{contents: [{role: "user", parts: [{text: $prompt}]}]}' \
            > payload.json

          RESP="$(curl -sS -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @payload.json)"

          OUT="$(echo "$RESP" | jq -r '.candidates[0].content.parts[0].text // empty')"

          if [ -z "$OUT" ]; then
            echo "Gemini response was empty or unexpected:" >&2
            echo "$RESP" | head -c 2000 >&2
            OUT="(Geminiã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚APIå¿œç­”å½¢å¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚)"
          fi

          DELIM="GEMINI_EOF_$(date +%s)"
          {
            echo "body<<${DELIM}"
            echo "## ğŸ¤– Gemini Review"
            echo
            echo "_model: ${MODEL}_"
            echo
            echo "$OUT"
            echo "${DELIM}"
          } >> "$GITHUB_OUTPUT"

      - name: Post review comment to PR
        if: steps.pr.outputs.isTrustedRequester == 'true' && steps.pr.outputs.isFork != 'true' && steps.secret_guard.outputs.present == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          COMMENT_BODY: ${{ steps.gemini.outputs.body }}
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const body = process.env.COMMENT_BODY;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
