name: Gemini PR Review (with GitHub Suggestions)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: gemini-review-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  review:
    if: |
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '/gemini review'))
      ||
      (github.event_name == 'pull_request_target' && github.event.pull_request.draft == false)

    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR number & basic guards
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const isIssueComment = context.eventName === 'issue_comment';
            const prNumber = isIssueComment
              ? context.payload.issue.number
              : context.payload.pull_request.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // Safe-by-default: do not use repository secrets on fork PRs.
            const isFork = pr.head.repo.full_name !== pr.base.repo.full_name;

            core.setOutput('number', String(prNumber));
            core.setOutput('isFork', String(isFork));
            core.setOutput('headSha', pr.head.sha);
            core.setOutput('baseSha', pr.base.sha);
            core.setOutput('title', pr.title || '');
            core.setOutput('author', pr.user?.login || '');

      - name: Skip forks (safe default)
        if: steps.pr.outputs.isFork == 'true'
        run: |
          echo "Fork PR detected; skipping Gemini review to avoid secrets exposure."
          exit 0

      - name: Fetch PR diff (no checkout)
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ steps.pr.outputs.number }}');

            const res = await github.request('GET /repos/{owner}/{repo}/pulls/{pull_number}', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              headers: { accept: 'application/vnd.github.v3.diff' },
            });

            let diffText = res.data;

            // Avoid token explosion on huge changesets.
            const MAX_CHARS = 120000;
            if (diffText.length > MAX_CHARS) {
              diffText = `${diffText.slice(0, MAX_CHARS)}\n\n[TRUNCATED]\n`;
            }

            core.setOutput('text', diffText);

      - name: Build Gemini prompt
        id: prompt
        env:
          DIFF_TEXT: ${{ steps.diff.outputs.text }}
        run: |
          cat > prompt.txt <<'PROMPT'
          „ÅÇ„Å™„Åü„ÅØ GitHub ‰∏ä„ÅÆ„Éó„É´„É™„ÇØ„Ç®„Çπ„Éà„Çí„É¨„Éì„É•„Éº„Åô„Çã„Ç∑„Éã„Ç¢„Ç®„É≥„Ç∏„Éã„Ç¢„Åß„Åô„ÄÇ
          ‰ª•‰∏ã„ÅÆ Diff „ÇíÂàÜÊûê„Åó„ÄÅProfinaut „ÅÆÈÅãÁî®ÂéüÂâáÔºàSafe-by-default / 1PR=1scope / contracts additive-only / Âç±Èô∫È†òÂüü„É≠„ÉÉ„ÇØÔºâ„Å´Âé≥ÂØÜ„Å´Âæì„Å£„Å¶„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          „ÄêÊúÄÂÑ™ÂÖà„ÅÆË¶≥ÁÇπÔºàÂøÖÈ†à„ÅßÁ¢∫Ë™çÔºâ„Äë
          1) Safe-by-default:
             - ‰∏çÊòé/Êï¥Âêà‰∏çËÉΩ/‰æùÂ≠ò‰∏çÈÅîÊôÇ„Å´ ‚ÄúÊñ∞Ë¶èÁô∫Ê≥®Á¶ÅÊ≠¢‚Äù „ÇíÊó¢ÂÆö„Å´„Åß„Åç„Å¶„ÅÑ„Çã„Åã
             - SAFE_MODE / Kill Switch / Close-only / Flatten „ÅÆÈÄ∏ËÑ±„ÇÑÊäú„Åë„Åå„Å™„ÅÑ„Åã
          2) 1PR=1scope:
             - Â§âÊõ¥„ÅåË§áÊï∞„Çπ„Ç≥„Éº„Éó„Å´Ë∑®„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÅãÔºàË∑®„Çã„Å™„ÇâÂàÜÂâ≤„ÇíÊèêÊ°àÔºâ
          3) contracts:
             - contracts/** „ÅØ additive-onlyÔºàËøΩË®ò„ÅÆ„ÅøÔºâ„Åã„ÄÇÁ†¥Â£äÂ§âÊõ¥„ÅåÁñë„Çè„Çå„ÇãÂ†¥Âêà„ÅØ„Éñ„É≠„ÉÉ„ÇØ„ÄÇ
          4) Âç±Èô∫È†òÂüüÔºàCI/infra/lockfile/migrations Á≠âÔºâ:
             - Â§âÊõ¥„ÅåÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÄÅÂÖ•„Å£„Å¶„ÅÑ„Çã„Å™„ÇâÁêÜÁî±„Å®„É™„Çπ„ÇØ„ÇíÊòéÁ¢∫Âåñ

          „Äê„É¨„Éì„É•„ÉºÂá∫Âäõ„É´„Éº„É´ÔºàÈáçË¶ÅÔºâ„Äë
          - ÊåáÊëò„ÅØÊó•Êú¨Ë™û„ÅßÊõ∏„Åè„Åì„Å®„ÄÇ
          - ‰øÆÊ≠£ÊèêÊ°à„Åå ‚ÄúÂÖ∑‰ΩìÁöÑ„Å™„Ç≥„Éº„ÉâÂ§âÊõ¥‚Äù „Å´„Å™„ÇãÂ†¥Âêà„ÅØ„ÄÅÂøÖ„Åö GitHub Suggestion Ë®òÊ≥ï„Çí‰Ωø„ÅÜ„Åì„Å®Ôºà„ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØÈÅ©Áî®„Åß„Åç„ÇãÂΩ¢Ôºâ„ÄÇ
            ‰æã:
            ```suggestion
            ‰øÆÊ≠£Âæå„ÅÆ„Ç≥„Éº„Éâ„ÅÆ„Åø
            ```
          - suggestion „Éñ„É≠„ÉÉ„ÇØ„ÅØ„ÄåÂ∑ÆÂàÜÂØæË±°„ÅÆ„Éï„Ç°„Ç§„É´„ÉªË©≤ÂΩìÁÆáÊâÄ„Å´ÂØæÂøú„Åô„ÇãÊúÄÂ∞èÂçò‰Ωç„Äç„ÅßÂá∫„Åô„Åì„Å®ÔºàÂ∑®Â§ß„Å™ÁΩÆÊèõ„ÅØÁ¶ÅÊ≠¢Ôºâ„ÄÇ
          - ‰øÆÊ≠£Ê°à„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÁÑ°ÁêÜ„Å´ suggestion „Çí‰Ωú„Çâ„Å™„ÅÑ„Åì„Å®„ÄÇ
          - ËâØ„ÅÑÁÇπ„Åå„ÅÇ„Çå„Å∞Áü≠„ÅèË§í„ÇÅ„Çã„Åì„Å®Ôºà„Åü„Å†„ÅóÈÅéÂâ∞„Å´Áß∞Ë≥õ„Åó„Å™„ÅÑÔºâ„ÄÇ
          - ÊúÄÂæå„Å´ ‚Äú„Åì„ÅÆPR„Çí„Åù„ÅÆ„Åæ„Åæ„Éû„Éº„Ç∏„Åó„Å¶ËâØ„ÅÑ„Åã‚Äù „Çí„ÄåOK / Êù°‰ª∂‰ªò„ÅçOK / NG„Äç„ÅßÁµêË´ñ„Åó„ÄÅÁêÜÁî±„ÇíÁÆáÊù°Êõ∏„Åç„ÅßÁ§∫„Åô„Åì„Å®„ÄÇ

          „ÄêDiff„Äë
          PROMPT

          printf '%s\n' "$DIFF_TEXT" >> prompt.txt

      - name: Call Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL }}
        run: |
          set -euo pipefail
          : "${GEMINI_API_KEY:?Missing secrets.GEMINI_API_KEY}"
          MODEL="${GEMINI_MODEL:-gemini-1.5-pro}"

          RESP="$(curl -sS -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            --data-binary @- <<JSON
          {
            "contents": [{
              "role": "user",
              "parts": [{"text": $(jq -Rs . < prompt.txt)}]
            }]
          }
          JSON
          )"

          OUT="$(echo "$RESP" | jq -r '.candidates[0].content.parts[0].text // empty')"

          if [ -z "$OUT" ]; then
            echo "Gemini response was empty or unexpected:" >&2
            echo "$RESP" | head -c 2000 >&2
            OUT="(Gemini„ÅÆÂøúÁ≠î„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇAPIÂøúÁ≠îÂΩ¢Âºè„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ)"
          fi

          {
            echo "body<<EOF"
            echo "## ü§ñ Gemini Review"
            echo
            echo "_model: ${MODEL}_"
            echo
            echo "$OUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post review comment to PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          COMMENT_BODY: ${{ steps.gemini.outputs.body }}
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const body = process.env.COMMENT_BODY;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
