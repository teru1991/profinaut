name: 🔐 Vault Bootstrap (on repository_dispatch)

on:
  repository_dispatch:
    types: [vault-first-boot]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    env:
      VAULT_ADDR: https://vault.profinaut.studiokeke.com:8200
      VAULT_CERT: /tmp/origin_ca.pem
      CF_ACCESS_CLIENT_ID: ${{ secrets.VAULT_CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.VAULT_CF_ACCESS_CLIENT_SECRET }}
      POLICY_DIR: docker/vault/policies
      APPROLE_DEFINITIONS: docker/vault/approle_definitions.yaml
      ENV_GENERATED: docker/vault/scripts/env.generated
      SERVICE_TOKEN_POLICIES: "admin,ci-maintainer"
      SERVICE_TOKEN_TTL: "24h"
      BOOTSTRAP_PGP_KEYS: ${{ secrets.BOOTSTRAP_PGP_KEYS }}

    steps:
      - uses: actions/checkout@v4

      - name: Deps
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq
          pip install requests pyyaml
          mkdir -p /tmp
          echo "${{ secrets.VAULT_ORIGIN_CA_PEM }}" > "$VAULT_CERT"

      - name: Health
        id: health
        run: |
          r=$(curl -sS --cacert "$VAULT_CERT" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            "$VAULT_ADDR/v1/sys/health")
          echo "$r" | jq .
          echo "initialized=$(echo "$r" | jq -r .initialized)" >> "$GITHUB_OUTPUT"

      - name: Init (once)
        if: steps.health.outputs.initialized == 'false'
        id: init
        run: |
          body=$(jq -n '{recovery_shares:5, recovery_threshold:3}')
          if [ -n "${BOOTSTRAP_PGP_KEYS:-}" ]; then
            IFS=',' read -r -a arr <<< "$BOOTSTRAP_PGP_KEYS"
            pgp_json=$(printf '%s\n' "${arr[@]}" | jq -R . | jq -s .)
            body=$(echo "$body" | jq --argjson pgp "$pgp_json" '. + {pgp_keys:$pgp}')
          fi
          resp=$(curl -sS --fail -X PUT \
            --cacert "$VAULT_CERT" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            -H "Content-Type: application/json" \
            -d "$body" "$VAULT_ADDR/v1/sys/init")
          echo "$resp" | jq 'del(.root_token, .initial_root_token)'
          echo "root_token=$(echo "$resp" | jq -r '.root_token // .initial_root_token')" >> "$GITHUB_OUTPUT"

      - name: Policies (root token)
        if: steps.health.outputs.initialized == 'false'
        env:
          VAULT_TOKEN: ${{ steps.init.outputs.root_token }}
        run: python3 docker/vault/scripts/create_policies.py

      - name: AppRoles (root token)
        if: steps.health.outputs.initialized == 'false'
        env:
          VAULT_TOKEN: ${{ steps.init.outputs.root_token }}
        run: python3 docker/vault/scripts/create_approles.py

      - name: (Optional) Service token (no secrets write here)
        if: steps.health.outputs.initialized == 'false'
        env:
          VAULT_TOKEN: ${{ steps.init.outputs.root_token }}
        run: |
          body=$(jq -n --arg pol "$SERVICE_TOKEN_POLICIES" --arg ttl "$SERVICE_TOKEN_TTL" \
                 '{policies:($pol|split(",")), ttl:$ttl}')
          resp=$(curl -sS --fail -X POST \
            --cacert "$VAULT_CERT" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$body" "$VAULT_ADDR/v1/auth/token/create")
          tok=$(echo "$resp" | jq -r '.auth.client_token')
          echo "::add-mask::$tok"
          echo "✅ service token issued (masked)"

      - name: Output env.generated
        if: steps.health.outputs.initialized == 'false'
        env:
          VAULT_TOKEN: ${{ steps.init.outputs.root_token }}
        run: |
          python3 docker/vault/scripts/create_approles.py
          sed -E 's/=(.{6}).+$/=\1***MASKED***/' "$ENV_GENERATED" || true

      - name: Revoke root
        if: steps.health.outputs.initialized == 'false'
        env:
          VAULT_TOKEN: ${{ steps.init.outputs.root_token }}
        run: |
          curl -sS --fail -X POST \
            --cacert "$VAULT_CERT" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/auth/token/revoke-self" && echo "revoked"
      - name: Copy master .env to docker/vault/.env
        run: |
          if [ ! -f ".env" ]; then
            echo "❌ repo root に .env がありません"; exit 1
          fi
          mkdir -p docker/vault
          cp -f .env docker/vault/.env
          echo "✅ copied .env → docker/vault/.env"

      - name: Merge env.generated → docker/vault/.env
        env:
          VAULT_TOKEN: ${{ steps.init.outputs.root_token }}
        run: |
          # env.generated は create_approles.py が出力済みの想定
          if [ ! -f "docker/vault/scripts/env.generated" ]; then
            echo "❌ env.generated が見つかりません"; exit 1
          fi
          bash docker/vault/scripts/merge_env.sh \
            .env \
            docker/vault/.env \
            docker/vault/scripts/env.generated

          # マスクしてログ表示（値の露出はしない）
          awk -F= '
            $0 ~ /^[A-Za-z_][A-Za-z0-9_]*=/ {
              v=$2; if(length(v)>6){ printf "%s=%s***MASKED***\n",$1,substr(v,1,6) }
              else { print $1"="v }
              next
            }
            { print }
          ' docker/vault/.env | sed -n "1,20p"
